package gen

import (
	"runtime/debug"

	"github.com/syssam/velox/schema/field"
)

// =============================================================================
// Grouped Configuration (for cleaner API)
// =============================================================================

// OutputConfig groups output-related settings.
type OutputConfig struct {
	// Target defines the filepath for the target directory that
	// holds the generated code. For example, "./project/velox".
	Target string

	// Package defines the Go package path of the target directory.
	// For example, "github.com/org/project/velox".
	Package string

	// Header allows users to provide an optional header signature for
	// the generated files. It defaults to the standard 'go generate'
	// format: '// Code generated by velox, DO NOT EDIT.'.
	Header string
}

// SchemaConfigGroup groups schema-related settings.
// Named SchemaConfigGroup to avoid conflict with the Schema field.
type SchemaConfigGroup struct {
	// Schema holds the Go package path for the user velox/schema.
	// For example, "<project>/velox/schema".
	Schema string

	// IDType specifies the type of the id field in the codegen.
	// The supported types are string and int, which is also the default.
	IDType *field.TypeInfo

	// Storage configuration for the codegen. Defaults to sql.
	Storage *Storage
}

// =============================================================================
// Config convenience methods
// =============================================================================

// Output returns the output configuration grouped together.
// This is a convenience method for accessing related settings.
func (c *Config) Output() OutputConfig {
	return OutputConfig{
		Target:  c.Target,
		Package: c.Package,
		Header:  c.Header,
	}
}

// SchemaOpts returns the schema configuration grouped together.
// This is a convenience method for accessing related settings.
func (c *Config) SchemaOpts() SchemaConfigGroup {
	return SchemaConfigGroup{
		Schema:  c.Schema,
		IDType:  c.IDType,
		Storage: c.Storage,
	}
}

// ModuleInfo returns the velox module version.
func (c *Config) ModuleInfo() (m debug.Module) {
	const pkg = "github.com/syssam/velox"
	info, ok := debug.ReadBuildInfo()
	if !ok {
		return
	}
	// Was running as a CLI (velox/cmd/velox).
	if info.Main.Path == pkg {
		return info.Main
	}
	// Or, as a main package (velox/veloxc).
	for _, dep := range info.Deps {
		if dep.Path == pkg {
			return *dep
		}
	}
	return
}

// FeatureEnabled reports if the given feature name is enabled.
// It's exported to be used by the template engine as follows:
//
//	{{ with $.FeatureEnabled "privacy" }}
//		...
//	{{ end }}
func (c *Config) FeatureEnabled(name string) (bool, error) {
	for _, f := range allFeatures {
		if name == f.Name {
			return c.featureEnabled(f), nil
		}
	}
	return false, &ConfigError{
		Option:  "FeatureEnabled",
		Value:   name,
		Message: "unexpected feature name",
	}
}

// featureEnabled reports if the given feature-flag is enabled.
func (c *Config) featureEnabled(f Feature) bool {
	for i := range c.Features {
		if f.Name == c.Features[i].Name {
			return true
		}
	}
	return false
}

// HasFeature checks if the given feature is enabled by name.
func (c *Config) HasFeature(name string) bool {
	for i := range c.Features {
		if c.Features[i].Name == name {
			return true
		}
	}
	return false
}

// DefaultConfig returns a Config with default values applied.
func DefaultConfig() *Config {
	return &Config{
		Header: defaultHeader,
		IDType: defaultIDType,
	}
}

// defaultHeader is the default header for generated files.
const defaultHeader = "// Code generated by velox, DO NOT EDIT."
